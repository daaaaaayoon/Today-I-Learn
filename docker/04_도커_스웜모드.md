## Ch4. 도커 스웜

## 🐳 도커 스웜

필독 : [도커 스웜을 이용한 쉽고 빠른 분산 서버 관리](https://subicura.com/2017/02/25/container-orchestration-with-docker-swarm.html)

지금까지 알아본 도커 사용법은 대부분 하나의 호스트를 기준으로 한다.

하나의 호스트 머신에서 도커 엔진을 구동하다가 CPU나 메모리, 디스크 용량과 같은 자원이 부족하다면?

⇒ 가장 많이 사용하는 방법 : 여러 대의 서버를 클러스터로 만들어 필요한 만큼 자원을 병렬로 확장해나간다.

(여러 대를 하나의 자원 풀로 만들어 사용 가능하며, 성능 좋다는 값비싼 서버를 사지 않아도됨) 

**의문**

- 스케줄러, 로드밸런서 문제 : 여러 대 중 어떤 서버에 컨테이너를 할당할건데?
- 고가용성 보장 : 클러스터 내의 서버가 다운되었을때 어떻게 할건데?

⇒ 이런 문제를 해결한 오픈 소스 : 도커 스웜, 스웜 모드

## 1️⃣ 도커 스웜 모드란?

: 여러 대의 도커 서버를 하나의 클러스터로 만들어 컨테이너를 생성, 로드밸런싱 등 여러 기능을 제공하는 오픈소스

- 스웜 클러스터에 등록된 서버의 컨테이너를 쉽게 관리 가능
- 다양한 전략을 세워 컨테이너를 특정 도커 서버에 할당 가능하고 유동적으로 서버 확장 가능

    → 같은 컨테이너를 동시에 여러 개 생성해 필요에 따라 유동적으로 컨테이너의 수를 조절 가능

- 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 자체적으로 지원
- 클러스터링을 위한 모든 도구가 도커 엔진 자체에 내장되어 있음 → 쉽게 서버 클러스터 구축 가능

    (여러 개의 도커 서버를 하나의 클러스터로 구성하기 위해 필요한 것들 : 각종 정보를 저장하고 동기화하는 분산 코디네이터, 클러스터 내의 서버를 관리하고 제어하는 매니저, 각 서버를 제어하는 에이전트 등)

**vs 쿠버네티스**

스웜 모드와 비슷하지만 더욱 복잡하고 많은 기능을 제공하는 솔루션

## 2️⃣ 도커 스웜 모드 사용하기

### (1) 도커 스웜 모드 확인

- 도커 엔진 자체에 내장되어 있음

`docker info | grep Swarm` => Swarm: inactive(비활성)

지금까지는 단일 도커 서버에서 도커 엔진을 사용 ⇒ 비활성 상태

### (2) 도커 스웜 모드 구조

<img width="698" alt="스크린샷 2021-09-06 오후 11 01 15" src="https://user-images.githubusercontent.com/53184797/132228848-27b4be36-8d26-4939-83fa-b1bf9b917b82.png">

1. **매니저 노드**

    : 워커 노드를 관리하기 위한 도커 서버 

    - 기본적으로 워커 노드의 역할을 포함 (컨테이너가 생성될 수 있다)
    - 1개 이상 있어야 함
    - 매니저 노드 다중화 권장 (매니저의 부하를 분산하고 특정 매니저 노드가 다운됐을 때 정상적으로 스웜 클러스터 유지 가능하기 때문에)
2. **워커 노드**

    : 실제 컨테이너가 생성되고 관리되는 도커 서버

### (3) 도커 스웜 모드 클러스터 구축 & 다루기

- 사용할 서버의 IP와 호스트 이름

    ```
    swarm-manager 192.168.0.100
    swarm-worker1 192.168.0.101
    swarm-worker2 192.168.0.102
    ```

- **매니저 노드** 생성 : 매니저 역할 서버에서 스웜 클러스터 시작

    `docker swarm init —advertise-addr [IP 주소]`

    - IP 주소 = 다른 도커서버가 매니저 노드에 접근 위한 주소 = 매니저 노드의 IP 주소
- **워커 노드** 추가

    매니저 노드 생성 시, 출력되는 명령어 입력

    `docker swarm join --token [매니저 노드 생성 시 주어진 토큰] [매니저 IP주소:2377]`

- 스웜 클러스터에 추가되었는지 확인 (매니저 노드에서 확인)

    `docker node ls`

- **새로운 매니저 or 워커 노드를 추가하기 위한 명령어 출력**
    - 매니저 노드 : `docker swarm join-token manager`
    - 워커 노드 : `docker swarm join-token worker`

- **토큰**
    - 공개되면 누구든 해당 스웜 클러스터에 노드를 추가 가능 ⇒ 보안적 문제
    - 주기적 변경 (매니저 노드에서만 가능)

        ⇒ 토큰 갱신 명령어 : `docker swarm join-token —rotate [매니저 노드 이름]`

- **노드 삭제**
    - **매니저 노드 삭제**
        - 해당 매니저 노드에서 삭제 : `docker swarm leave —force`
    - **워커 노드 삭제**
        - 해당 워커 노드에서 삭제 : `docker swarm leave`
        - 매니저 노드에서 삭제가 아닌 Down 상태로 인지 - 확인 : `docker node ls`

            ⇒ 매니저 노드에서 워커 노드 삭제 - `docker node rm [워커 노드 이름]`

- **노드 역할 변경**
    - 워커 노드 → 매니저 노드 : `docker node promote [워커 노드 이름]`
    - 매니저 노드 → 워커 노드 : `docker node demote [매니저 노드 이름]`

        (매니저 노드가 1개일때는 사용 불가)

### (4) 도커 스웜 모드 서비스 개념

1. **제어 단위 - 서비스**
    - 지금까지의 도커 명령어(docker run, rm...)의 제어 단위 : 컨테이너
    - 도커 스웜 모드 명령어의 제어 단위 : **서비스**

    - 서비스 내에 컨테이너는 1개 이상 존재 가능, 이를 Task라고 한다.
2. **기본 동작**

    ex) 우분투 이미지로 서비스 생성, 컨테이너 수 3개로 설정

    <img width="421" alt="스크린샷 2021-09-06 오후 11 01 22" src="https://user-images.githubusercontent.com/53184797/132228851-3a67d7cc-46e9-4748-9548-afb92afb11e4.png">
    - 스웜 스케줄러 - 컨테이너를 할당할 노드 선정, 해당 노드에 컨테이너를 분산해서 할당

        (각각 하나씩 할당되지 않을 수도 있음, 여기서 함께 생성된 컨테이너 = replica)

    - 서비스에 설정된 레플리카의 수만큼의 컨테이너가 스웜 클러스터 내에 존재해야함.

        <img width="637" alt="스크린샷 2021-09-06 오후 11 01 26" src="https://user-images.githubusercontent.com/53184797/132228855-c1482bcb-e8e1-486e-8dfa-ba8a4c8bc76e.png">

        → 스웜이 스웜 클러스터 내의 상태를 계속 확인 

        → 존재하지 않거나 정지한 상태라면 새로운 컨테이너 레플리카를 클러스터에 생성

    - 롤링 업데이터 기능 제공 - 컨테이너의 이미지를 순서대로 변경해 서비스 자체가 다운되는 시간 없이 컨테이너의 업데이트 가능