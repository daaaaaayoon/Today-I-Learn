# Docker Image & Container

## 🐳 도커 이미지와 컨테이너

### 1️⃣ 도커 이미지

- 컨테이너를 생성, 실행할 때 **읽기 전용 파일**
- [저장소 이름]/**[이미지 이름]:[태그]**
- 저장소 이름과 태그는 생략 가능 (태그 생략 시, latest로 적용)

### 2️⃣ 도커 컨테이너

- **도커 이미지로 생성**하며, 해당 이미지의 목적에 맞는 파일이 들어있는 파일 시스템과 격리된 시스템 자원 및 네트워크를 사용할 수 있는 **독립된 공간**
- **독립된 파일 시스템, 호스트와 분리** → 그 공간의 애플리케이션을 삭제해도 다른 컨테이너나 호스트에 영향을 주지 않음

## 🐳 도커 컨테이너 다루기 (CLI)

### 1️⃣ 도커 컨테이너 생성 : run, create

<img width="705" alt="스크린샷 2021-08-05 오후 3 29 23" src="https://user-images.githubusercontent.com/53184797/128302264-944546bd-0a7d-49d8-88cb-d65aa898df86.png">

1. **run** : 컨테이너 생성과 동시에 시작하며 컨테이너 내부로 들어감

    ```docker
    docker run -i -t [이미지 이름]
    ```

    - `-i` : 상호 입출력, -t : tty 활성 ⇒ bash 셸을 사용하도록 설정
    - `exit` : 컨테이너 내부에서 빠져나옴과 동시에 컨테이너 정지
    - `Ctrl + P, Q` : 컨테이너를 정지하지 않고 빠져나옴
2. **create** : 컨테이너를 생성하지만 시작하지 않으며 컨테이너 내부로 들어가지 않음

    ```docker
    docker create -i -t --name [컨테이너 이름] [이미지 이름]:[태그]
    ```

    - 컨테이너를 시작 : `docker start [컨테이너 이름]`
    - 컨테이너 내부로 들어가고 싶을 때 : `docker attach [컨테이너 이름]`

### 2️⃣ 도커 컨테이너 목록 확인 : ps

- `docker ps` : 정지되지 않은 컨테이너만 출력
- `docker ps -a` : 정지된 컨테이너를 포함한 모든 컨테이너 출력

**컨테이너 목록 & 정보**

![컨테이너 정보 출력 화면](https://user-images.githubusercontent.com/53184797/128302760-8143fece-fee6-40fc-a135-c8b13694e57e.png)


- CONTAINER ID : 컨테이너 자동 할당 고유 ID
- IMAGE : 컨테이너를 생성할 때 사용된 이미지의 이름
- COMMAND : 컨테이너가 시작될 때 실행될 명령어 (대부분 이미지에 미리 내장되어 있음)

    → centos:7 이미지에 /bin/bash라는 커맨드가 내장되어 있기 때문에 컨테이너 생성 시 별도의 커맨드를 설정하지 않은 것임. 그리고 시작할 때 /bin/bash 명령어가 실행되어서 상호 입출력이 가능한 셸 환경을 사용할 수 있었던 것임 (변경 명령어 : `echo [명령어]`)

- CREATED : 컨테이너가 생성되고 난 뒤 흐른 시간
- STATUS : 컨테이너의 상태 (Up : 실행 중, Exited : 종료, Pause : 일시 정지)
- PORTS : 컨테이너가 개방한 포트와 호스트에 연결한 포트 나열
- NAMES : 컨테이너의 고유 이름 (rename 명령어로 다시 설정 가능)

### 3️⃣ 컨테이너 삭제 : rm

- `docker stop [컨테이너 이름]` : 실행 중인 컨테이너는 삭제 불가하므로 정지
- `docker rm [컨테이너 이름]` : 컨테이너 삭제
- `docker rm -f [컨테이너 이름]` : 실행 중인 컨테이너 삭제

### 4️⃣ 컨테이너를 외부에 노출

- 네트워크 인터페이스 확인 : `ifconfig`
- 컨테이너는 가상 IP 주소를 할당받음
- 기본적으로 도커는 172.17.0.x의 IP를 순차적으로 할당

❓**외부에 컨테이너의 애플리케이션을 노출하고 싶다면?** <br />
+ `-p [호스트의 포트]:[컨테이너의 포트]`
    ```docker
        docker run -i -t -p 80:80 --name mywebserver ubuntu:14.04    
    ```

+ 또는 호스트의 특정 IP를 사용하고 싶은 경우 : `-p [호스트의 특정 IP]:[컨테이너의 포트]`
    ```docker
        docker run -i -t 
        -p 3306:3306 
        -p 192.168.0.100:7777:80 # 호스트의 특정 IP를 사용하고 싶은 경우
        ubuntu:14.04
    ```

- ex) 아파치 웹 서버 설치 & 웹 브라우저에서 접근 : `[호스트의 IP 주소]:80`

    ```docker
    apt-get update
    apt-get install apache2 -y
    service apache2 start
    ```
    <img width="332" alt="스크린샷 2021-08-05 오후 3 29 30" src="https://user-images.githubusercontent.com/53184797/128302279-e7fdb61a-3e4f-4a2b-8b2c-9ec815cf3bed.png">

### 5️⃣ 컨테이너 애플리케이션 구축

컨테이너에 여러개의 애플리케이션을 동작시키는 것이 아닌, 

컨테이너에 애플리케이션을 하나만 동작시키면, 

컨테이너 간의 독립성을 보장함과 동시에 애플리케이션의 버전관리, 소스 코드 모듈화 등이 쉬워짐

ex) 구축해보기

- mariadb 데이터베이스 컨테이너

    ```docker
    docker run -d  # 하나의 터미널을 차지하는 mysqld
    --name wp_db
    -e MYSQL_ROOT_PASSWORD=password
    mariadb
    ```

- 워드프레스 웹 서버 컨테이너

    ```docker
    docker run -d  # 하나의 터미널을 차지하는 apache2-foreground
    --namd wp
    -e WORDPRESS_DB_PASSWORD=password
    --link wp_db:mariadb
    -p 80 # 호스트의 포트 중 하나와 컨테이너의 80번 포트가 연결된다 (ps로 확인)
    wordpress
    ```

**명령어 옵션**

- `-i -t` : 컨테이너 내부로 진입하도록 attach 가능한 상태로 설정 ⇒ 입출력이 활성화된, 상호작용 가능한 셸 환경
- `-d` : detached 모드 = 입출력이 없는 상태로 컨테이너 실행

    ⇒ 컨테이너 내부에서 프로그램이 터미널을 차지하는 foreground로 실행하고, 사용자의 입력을 받지 않는다

    ⇒ detached 모드인 컨테이너는 반드시 컨테이너 내에서 프로그램이 실행되어야 하며, foreground 프로그램(하나의 터미널을 차지)이 실행되지 않으면 컨테이너는 종료된다

❓**detached 모드?**

- mariadb foreground로 실행 → log만 볼 수 있고 입출력 불가

    ```docker
    docker -i -t mariadb
    ```

    ⇒ detached 모드로 백그라운드에서 동작하도록 해야한다.

❓**백그라운드 모드의 컨테이너에서 bash shell, 상호 입출력을 하고 싶다면?**

- `attach` (x) : -d 옵션이므로 로그를 보게 됨
- `exec` (o) : 컨테이너 내부 셸 사용 가능
    - `-i -t` 옵션 사용

        ```docker
        docker exec -i -t mariadb /bin/bash  # /bin/bash 프로세스 실행, -i -t 입출력 가능 
        echo $MYSQL_ROOT_PASSWORD            # mariadb 비밀번호 확인
        ```

    - `-i -t` 옵션을 쓰지 않는다면, 컨테이너 내부에서 실행한 명령어에 대한 결과만 반환

        ```docker
        docker exec wordpressdb ls /
        bin
        boot
        dev
        ...
        ```

❓**다른 컨테이너로 접근하고자 할 때, 어떻게 쉽게 접근하지?** 

- `—link`
    - 다른 컨테이너로 접근하고자 할 때, 별명으로 접근할 수 있게 해주는 옵션
    - 왜 사용? ⇒ NAT으로 할당받은 내부 IP를 사용한다면 컨테이너를 재시작할 때마다 재할당 해야함
    - deprecated될 가능성이 있음 → **도커 브리지 네트워크**와 동일하므로 대체